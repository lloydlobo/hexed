<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>hextxt</title>
        <link href="css/style.css" rel="stylesheet">
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="wasm_exec.js"></script>
        <script src="//unpkg.com/alpinejs" defer></script>
        <!-- Function declaration and implementations --------------------- -->
        <script>
        const go = new Go();
        WebAssembly.instantiateStreaming(fetch("main.wasm"), go.importObject).then((res)=>{
            go.run(res.instance);
            console.info("Wasm loaded successfully");
        }
        ).catch((err)=>{
                console.error("Failed to load Wasm:", err);
            }
            );

        /**
             * Triggered by a user event such as a button's `onclick` trigger.
             * Calls a Go function exposed via WebAssembly to process the input text.
             * Updates the output element with the result.
             * @return {void}
             */
        function callGo() {
            const textarea = document.getElementById("input");
            const options = document.getElementById("options");
            const text = textarea.value.replace(/[<>]/g, "");
            // Sanitize input for potential XSS atttacks or injection
            let hexdump;
            if (options.value === "") {
                // default for Option "hex"
                hexdump = getMessage(text);
            } else {
                hexdump = getMessage(text, options.value);
            }
            document.getElementById("outputBytes").textContent = hexdump;
        }

        /**
             * Copies the content of the output element to the clipboard.
             * @return {void}
             */
        function copyOutput() {
            const output = document.getElementById("outputBytes");
            const text = output.textContent;
            copyToClipboard(text);
        }

        /**
             * copyToClipboard copies a given string to the clipboard.
             * @param {string} s - The string to copy.
             * @return {void}
             */
        function copyToClipboard(s) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(s).then(()=>console.log("Text copied successfully"), (err)=>console.error("Failed to copy text:", err), );
                return;
            }

            const textarea = document.createElement("textarea");
            textarea.value = s;
            document.body.appendChild(textarea);
            textarea.select();

            try {
                document.execCommand("copy");
                console.log("Text copied successfully");
            } catch (err) {
                console.error("Fallback copy failed:", err);
                alert("Manual copy: " + s);
            }
            document.body.removeChild(textarea);
        }

        function readClipboard() {
            navigator.clipboard.readText().then((clipText)=>(document.getElementById("input").innerText += clipText), );
        }
        </script>
        <!-- -------------------------------------------------------------- -->
    </head>
    <body class="omni-theme">
        <article class="w-full scroll-mb-[var(--thread-trailing-height,150px)] text-token-text-primary focus-visible:outline-2 focus-visible:outline-offset-[-4px]">
            <div class="m-auto text-base py-[18px] px-3 md:px-4 w-full md:px-5 lg:px-4 xl:px-5">
                <div class="mx-auto flex flex-1 gap-4 text-base md:gap-5 lg:gap-6 md:max-w-3xl">
                    <!-- col-1 STUB: metadata gravatars etc... -->
                    <div class="hidden"></div>

                    <!-- col-2 MAIN: input+output -->
                    <div class="relative flex w-full min-w-0 flex-col">
                        <section>
                            <header>
                                <h1 class="font-mono font-bold tracking-tighter">
                                    hextxt
                                </h1>
                            </header>
                        </section>

                        <!-- INPUT ---------------------------------------- -->
                        <section>
                            <form onsubmit="event.preventDefault(); callGo();">
                                <div class="relative flex mt-5 items-center gap-8">
                                    <!-- EDITOR --------------------------- -->
                                    <div id="input-background"
                                        class="flex w-full cursor-text flex-col rounded-xl bg-zinc-900 transition-colors contain-inline-size"
                                        style="view-transition-name:var(--vt-composer)"
                                    >
                                        <div class="flex min-h-[48px] items-start pl-2!">
                                            <div class="min-w-0 max-w-full flex-1">
                                                <div class="text-primary max-h-[45dvh] max-h-80 overflow-auto default-browser">
                                                    <textarea autofocus=""
                                                        class="block min-h-40 w-full py-1 px-2.5 resize-none! border-0 bg-transparent px-0 py-2 text-primary placeholder:text-secondary"
                                                        cols="80"
                                                        data-virtualkeyboard="true"
                                                        id="input"
                                                        placeholder="Enter text">
                                                    </textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- ---------------------------------- -->
                                    <button type="submit"
                                        aria-label="Process text" 
                                        class="font-bold text-xs absolute right-0 bottom-0 text-zinc-800
                                        bg-zinc-50 h-8 w-8 rounded hover:text-zinc-600 rounded-full
                                        mx-[1.125rem] my-[.5rem] transition-colors" 
                                    >Go</button>
                                </div>

                                <!-- OPTIONS ------------------------------ -->
                                <div x-data="{ selected: '-C' }"
                                    class="flex gap-3 text-xs font-mono justify-between w-full mt-3" 
                                >
                                    <pre>$ hexdump <code 
                                        aria-label="hexdump option" 
                                        x-text="selected"
                                    ></code></pre>
                                    <div>
                                        <label for="options" class="sr-only">Select options</label>
                                        <select id="options" x-model="selected">
                                            <option value="-C">hex+ascii</option>
                                            <option value="">hex</option>
                                            <option value="--no-squeezing">nosqueeze</option>
                                        </select>
                                    </div>
                                </div>
                                <!-- -------------------------------------- -->
                            </form>
                        </section>
                        <!-- ---------------------------------------------- -->

                        <!-- OUTPUT --------------------------------------- -->
                        <section>
                            <div class="relative mt-14 py-1 px-2.5 rounded-xl" style="border:.5px solid #111111;">
                                <!-- Each rune outputs 3 bytes (2 hex digits + space). -->
                                <div>
                                    <header style="align-content:center; height:1.5rem; top:-.5rem; left:50%;"
                                        class="absolute flex text-xs font-mono" 
                                    >Output</header>
                                    <!-- COPY BUTTON ---------------------- -->
                                    <div class="sticky top-9 md:top-[5.75rem]">
                                        <div class="absolute bottom-1 -right-1 flex h-9 items-center">
                                            <div class="flex items-center rounded bg-token-sidebar-surface-primary px-0 font-sans text-xs text-token-text-secondary dark:bg-token-main-surface-secondary">
                                                <span class data-state="closed">
                                                    <button aria-label="Copy" class="flex gap-1 items-center bg-zinc-900 text-white text-xs leading-6 font-medium py-0 px-2 mb-2 rounded hover:bg-zinc-700" onclick="copyOutput()" type="button">
                                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="icon-sm scale-[.8]">
                                                            <path fill-rule="evenodd" clip-rule="evenodd" d="M7 5C7 3.34315 8.34315 2 10 2H19C20.6569 2 22 3.34315 22 5V14C22 15.6569 20.6569 17 19 17H17V19C17 20.6569 15.6569 22 14 22H5C3.34315 22 2 20.6569 2 19V10C2 8.34315 3.34315 7 5 7H7V5ZM9 7H14C15.6569 7 17 8.34315 17 10V15H19C19.5523 15 20 14.5523 20 14V5C20 4.44772 19.5523 4 19 4H10C9.44772 4 9 4.44772 9 5V7ZM5 9C4.44772 9 4 9.44772 4 10V19C4 19.5523 4.44772 20 5 20H14C14.5523 20 15 19.5523 15 19V10C15 9.44772 14.5523 9 14 9H5Z" fill="currentColor"></path>
                                                        </svg>
                                                        Copy
                                                    </button>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- HEXDUMP OUTPUT ------------------- -->
                                    <code class="overflow-scroll">
                                        <output aria-live="Processed text to hex" 
                                            class="overflow-x-scroll text-sm font-mono block min-h-20 py-2 min-w-[78ch]"
                                            id="outputBytes"
                                            style="white-space:pre;"
                                        ></output>
                                    </code>
                                    <!-- ---------------------------------- -->
                                </div>
                        </section>
                        <!-- ------------------------------------------------->
                    </div>
                </div>
            </div>
        </article>
    </body>
</html>
